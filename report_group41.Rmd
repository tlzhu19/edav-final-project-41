---
title: "Refugee Resettlements in the USA"
author: "Ji In Choi (jic2124), Jung Ah Shin (js5569), Olivia Wang (yw3324), Tiffany Zhu (tz2196)"
date: "December 12, 2019"
output:
  html_document:
    toc: true
    toc_float: true
    theme: journal
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
#install.packages("maps")
library(readxl)
library(tidyverse)
library(plotly)
library(knitr)
library(scales)
library(data.table)
```

# Introduction
## Motivation
The world’s forcibly displaced population hit its record high in 2017. Globally, at the end of 2017, the global refugee population increased by 2.9 million. By the end of the year, 68.5 million individuals were forcibly displaced worldwide as a result of persecution conflict, or generalized violence (https://www.unhcr.org/5b27be547.pdf). Despite the increase in demand for refugee admission and assistance, the United States specifically has taken a drastic turn away from supporting refugees. The number of refugees admitted to the United States has dropped from a recent high of 84,994 in FY 2016 to 22,874 in FY 2018 - the lowest in 40 years since 1977. The current ceiling for refugee admission has also dropped to 45,000, the lowest in the history of the current US resettlement program. Coming at a time when global numbers of refugees have reached record highs, the ratio of refugees admitted to the United States to the number of refugees worldwide has never been lower. For the first time, the US policy towards refugee admission is moving decisively against the trend of the total number of refugees worldwide (https://www.cgdev.org/blog/reflecting-world-refugee-day-trends-and-consequences-us-refugee-policy). 
The recent years thus mark a significant shift in refugee resettlement in the US, as a result, this report will be examining the refugee admission trend in the US over the past 10 years (2009-2018). 

## Background 
According to the UNHCR, `refugees` are defined as those who have been forced to leave their country due to violence, war, or persecution based on their race, religion, nationality, political opinion or particular social group. 

Process of refugee resettlement:
  
  1. The process of refugee resettlement to the U.S. is a lengthy and thorough process that takes approximately two years and involves numerous U.S. governmental agencies
  
  2. Refugees do not choose the country in which they would like to live. UNHCR, the UN Refugee Agency identifies the most vulnerable refugees for resettlement and then makes recommendations to select countries.
  
  3. Once a refugee is recommended to the U.S. for settlement, the U.S. government conducts a thorough vetting of each applicant. The process of which takes between 12 to 24 months and includes:
      * Screening by 8 federal agencies including the State Department, Department of Homeland Security and the FBI
      * Six security database checks and biometric security checks screened against U.S. federal databases
      * Medical screening
      * Three in-person interviews with Department of Homeland Security Officers

Under the Refugee Act of 1980, the president sets an annual ceiling for refugee admissions in consultation with Congress. The annual ceiling has varied over the years, from a high of 231,700 in FY 1980 to a prior low of 67,000 in FY 1986. Amid a large exodus of Syrinas from their war-torn country, President Obama raised the refugee ceiling for FY 2016 to 110,000. After taking office, Trump reduced the FY 2017 cap to 50,000, and for FY 2018 set one at a historic low of 45,000. Far fewer refugees, 22,874, were actually resettled in FY 2018.


## Questions
There are currently 25.9 million refugees in the world, indicating the dramatic growth in refugees over the past decade. This led us to question what the refugee resettlement trend has been for the past decade, and delve deeper than just the changes in the numbers of refugees. In order to better visualize the trend of refugee resettlement to the US, this report will be specifically focusing on the top 5 countries (Burma, Iraq, Somalia, Bhutan, Democratic Republic of the Congo) with the highest refugee resettlement population in the US, which accounted for 60.9% of the total refugee arrivals in the US (https://data.newamericaneconomy.org/en/refugee-resettlement-us/).

We are interested in answering the following questions to gain a better understanding of the refugee resettlements in the United States:
  
  1. What insights can we gain from temporal exploratory data analysis of refugee settlement patterns in the US?
      * Has there been increases/decreases in refugee resettlements population from 2009 - 2018?
      * Is there a correlation between change in refugee resettlement population and major political events that have happened over the 10 years?

  2. What insights can we gain from geographical visualization of refugee settlement patterns in the US over the 10 years? Why might some states have larger refugee settlements than others?
  
  3. What changes in demographic patterns (i.e., religion, gender, age, etc.) within the refugee population over the 10 years can we visualize? Can we observe any relationship between certain demographics and refugee settlements?
      * Given the number of religions included in the refugee population, we will be focusing on the top 5 religions in the world (Christianity, Islam, Hinduism, Buddhism, Sikhism). In Iraq, they separate the Muslim population into three categories: Muslim, Muslim Shiite, and Muslim Suni. For the purposes of this analysis, we will combine them as one (https://thecountriesof.com/top-5-largest-religions-in-the-world/).


# Data Sources

We first collected data from RPC (Refugee Processing Center), that provides refugee arrival information by state and nationality, by destination and nationality, by nationality and religion, and by demographic profile. 

We can select the time frame, nationality. 
Since the RPC website does not allow for faceting by year, we had to download the files year by year, and clean the data into the format we want for data analysis.


# Data Transformation
## Cleaning the Data in R

1. From the website, we were able to download '.xlsx' files. Raw files can be found [here](https://github.com/tlzhu19/edav-final-project-41/tree/master/data/raw).
2. Wrote two functions to clean Excel sheet for a given year. 
    i. `clean_arrival` to clean the Excel files for all refugee resettlements for each state.
    ii. `clean_demographics` to clean the Excel files for demographic information for refugees from specific countries (namely Bhutan, Burma, DRC, Iraq, and Somalia).
3. Wrote another function, `combine_files`, to combine each year's Excel file into one.
4. Saved these as csv files and uploaded to GitHub to easily access.

```{r}
# Used to clean the Arrivals data
clean_arrival <- function(file, sheet_name) {
  dat <- read_excel(file, sheet = sheet_name)
  dat1 <- subset(dat, select = c(...6, ...8,...9))
  dat2 <-subset(dat, select = c(...15,...18,...19)) 
  dat3 <-subset(dat, select = c(...23,...25,...27))

  dat1<-dat1 %>% drop_na()
  dat2<-dat2 %>% drop_na()
  dat3<-dat3 %>% drop_na()

  # set first row (State, Cases, Inds) as column name
  colnames(dat1) <- as.character(unlist(dat1[1,]))
  dat1 = dat1[-1, ]
  colnames(dat2) <- as.character(unlist(dat2[1,]))
  dat2 = dat2[-1, ]
  colnames(dat3) <- as.character(unlist(dat3[1,]))
  dat3 = dat3[-1, ]

  # Grouping columns together
  combined <- rbind(dat1,dat2)
  combined <- rbind(combined,dat3)

  # State,Cases,Inds

  combined$Cases <-as.numeric(as.character(combined$Cases))
  combined$Inds <-as.numeric(as.character(combined$Inds))
  
  return (combined)
}


```

```{r}
# Used to clean the Demographics data
clean_demographics <- function(file, sheet_name) {
  df <- read_excel(file, sheet = sheet_name)
  
  if (sheet_name == 'Age Group') {
    column_names = c('Department of State','...2', '...3', '...4')
  }
  else if (sheet_name == 'Religion') {
    column_names = c('Department of State','...2', '...4', '...6')
  }
  else if (sheet_name == 'Ethnicity' | sheet_name == 'Education' | sheet_name == 'Native Language') {
    column_names = c('Department of State','...2', '...3', '...5')
  }
  
  df2 <- subset(df, select = column_names)
  df3 <- df2[complete.cases(df2), ]
  df4 = df3[-nrow(df3), ]
  
  #print(file)
  #file_replaced <- gsub(pattern="demographics/", replacement=".", file, fixed = TRUE)
  
  # file_unpacked <- unlist(strsplit(file_replaced, split='.', fixed=TRUE))
  file_unpacked <- unlist(strsplit(file, 'demographics/'))
  file_unpacked2 <- unlist(strsplit(file_unpacked[2], '_Demographics'))
  country_name = file_unpacked2[1]

  colnames(df4) = c(sheet_name, 'Male', 'Female', 'Total')
  
  df4$country <- rep(country_name, nrow(df4))
  
  return(df4)
}

```

```{r}
# Cleans and combines all the files in the directory given by path
combine_files <- function(path, data_cleaner, sheet_name, title) {
  df = data.frame()
  files <- list.files(path=path, pattern="*.xlsx", full.names=TRUE, recursive=FALSE)
  for (file in files){
    cleaned_data = data_cleaner(file, sheet_name)
    year_extract <- unlist(strsplit(file, title))
    cleaned_data$Year <- as.numeric(gsub(".xlsx", "", year_extract[2]))
    df <- rbind(df, cleaned_data)}
  return (df)
}
#Examples

# path = "~/Desktop/Projects/EDAV/edav-final-project-41/data/raw/demographics"
# title = 'Demographics_'
# function
# sheet_name = 'Ethnicity'
# sheet_name = 'Age Group'
# sheet_name = 'Religion'
# sheet_name = 'Education'
# sheet_name = 'Native Language'
# data_cleaner = clean_demographics

# path = "~/Desktop/Projects/EDAV/edav-final-project-41/data/raw/all_arrivals"
# title = 'Arrivals_'
# sheet_name = 'Detailed'
# data_cleaner = clean_arrival

# df_test3 <- combine_files(path, clean_demographics, sheet_name, title)
```

```{r}
# Cleaned all_arrivals data converted to csv files
save_cleaned_all_arrivals <- function(path) {
    read_path = paste(path, "/edav-final-project-41/data/raw/all_arrivals", sep='')
    write_path = paste(path, "/edav-final-project-41/data/clean", sep='')
    title = 'Arrivals_'
    sheet_name = 'Detailed'
    data_cleaner = clean_arrival
    arrival_df <- combine_files(read_path, data_cleaner, sheet_name, title)
    write.csv(arrival_df, file = paste(write_path, "all_arrivals.csv", sep=''), row.names = FALSE)
}

# Cleaned demographics data converted to csv files
save_cleaned_all_demographics <- function(path) {
  read_path = paste(path, "/edav-final-project-41/data/raw/demographics", sep='')
  write_path = paste(path, "/edav-final-project-41/data/clean", sep='')
  title = 'Demographics_'
  sheet_names = c('Ethnicity', 'Age Group', 'Religion', 'Education', 'Native Language')
  file_names = c('ethnicity', 'age_group', 'religion', 'education', 'native_language')
  data_cleaner = clean_demographics
  
  for (i in 1:length(sheet_names)) {
    demographic_df <- combine_files(read_path, data_cleaner, sheet_names[i], title)
    file_name = paste(write_path, file_names[i], sep='')
    write.csv(demographic_df, file = paste(file_name, '.csv', sep=''), row.names = FALSE)
  }
}
```

## Cleaned Data Format
```{r}
# Read cleaned data from github
arrival_df = read.csv('https://raw.githubusercontent.com/tlzhu19/edav-final-project-41/master/data/clean/all_arrivals.csv')
age_df = read.csv('https://raw.githubusercontent.com/tlzhu19/edav-final-project-41/master/data/clean/age_group.csv')
ethnicity_df = read.csv('https://raw.githubusercontent.com/tlzhu19/edav-final-project-41/master/data/clean/ethnicity.csv')
religion_df = read.csv('https://raw.githubusercontent.com/tlzhu19/edav-final-project-41/master/data/clean/religion.csv')
education_df = read.csv('https://raw.githubusercontent.com/tlzhu19/edav-final-project-41/master/data/clean/education.csv')
native_language_df = read.csv('https://raw.githubusercontent.com/tlzhu19/edav-final-project-41/master/data/clean/native_language.csv')
```

After cleaning the data, we have six '.csv' files that can be found [here](https://github.com/tlzhu19/edav-final-project-41/tree/master/data/clean). 

1. `all_arrivals.csv`: The total number of refugee resettlements to each of the 50 states in the US from 2009-2018. All raw files to make this file can be found [here](https://github.com/tlzhu19/edav-final-project-41/tree/master/data/raw/all_arrivals).
```{r}
kable(head(arrival_df))
```

2. `age_group.csv`: 
```{r}
kable(head(age_df))
```

3. `education.csv`: 
```{r}
kable(head(education_df))
```

4. `ethnicity.csv`: 
```{r}
kable(head(ethnicity_df))
```

5. `native_language.csv`: 
```{r}
kable(head(native_language_df))
```

6. `religion.csv`: 
```{r}
kable(head(religion_df))
```

## Transforming the Data

**TODO: WRITE STUFF**

# Missing Values
The datasets from RPC (Refugee Processing Center) did not contain any missing values. However, we also noticed that our data contained a single row called “Unknown State”. Since this would not be plotted in our maps, we decided that it would be better to remove the data. Additionally, when we converted the `State` column to factors, there were 56. The extra 6 states are:

* American Samoa
* District of Columbia
* Guam
* Puerto Rico
* Unknown State
* Virgin Islands

We removed these rows since we are just curious about the fifty states.

In Education data, we observed the proportion of missing data compared to the total data. For example, Bhutan has more than 30% of missing data in education. 

```{r}
# CODE FOR PLOTTING PERCENTAGE OF MISSING DATA (Education)
na_df<- select(filter(education_df, Education == "Bio Data not Complete" | Education == "Unknown"),c(Education,Total, country, Year))
# Total sum of data 
total_df <- education_df %>% group_by(country)%>% summarize(Total = sum(Total))
# Total sum of missing data
na_df <- na_df %>% group_by(country) %>% summarize(Total = sum(Total))
# Change column name 
names(na_df)[2] <- "na_Total"
# Put two df together
combine_df <- cbind(total_df,na_df[2])
# Proportion of missing data 
combine_df <- transform(combine_df, proportion = na_Total/Total)
# Plot missing data
ggplot(combine_df, aes(x=country, y=proportion, fill=country))+
  geom_bar(stat="identity")+
  theme(legend.position="none", plot.title=element_text(hjust=0.5))+
  labs(x='Country', y='Proportion') +
  ggtitle("Missing Education Data by Country")


# Religion

#group by country and bar plot for Unknown ()
# CODE FOR PLOTTING PERCENTAGE OF MISSING DATA 
na_df1<- select(filter(religion_df, Religion == "Unknown"),c(Religion,Total, country, Year))
# Total sum of data 
total_df1 <- religion_df %>% group_by(country)%>% summarize(Total = sum(Total))
# Total sum of missing data
na_df1 <- na_df1 %>% group_by(country) %>% summarize(Total = sum(Total))
# Change column name 
names(na_df1)[2] <- "na_Total"
# Put two df together
combine_df1 <- cbind(total_df1,na_df1[2])
# Proportion of missing data 
combine_df1 <- transform(combine_df1, proportion = na_Total/Total)

# Plot missing data
ggplot(combine_df1, aes(x=country, y=proportion, fill=country))+
  geom_bar(stat="identity")+
  theme(legend.position="none", plot.title=element_text(hjust=0.5))+
  ggtitle("Missing Religion Data by Country")
```


# Results

## Temporal Analysis

Given our datasets, it is apparent that the temporal patterns of our data are of great importance to our analysis. As a result, to provide a general view of the overall change in resettlement population from 2009 to 2018, we chose to use a time series graph. 

In this graph, we have years on the x-axis, and population count on the y-axis. The green line indicates the ceiling set by the U.S. government for maximum of refugees that can be admitted. The red line indicates the actual number of individuals admitted. 
We hypothesize that the change in the refugee admission ceiling, and the actual refugee resettlement population are correlated with:

  1) The government administration at the time
  2) The US economy and major events in general
  
```{r}
# Compare ceilings with actual admissions
total_arrival_df <- arrival_df %>%
  group_by(Year) %>%
  summarise(Actual = sum(Inds))

# data from https://www.migrationpolicy.org/article/refugees-and-asylees-united-states#Refugee_Admission_Ceiling
Ceiling = c(80000, 80000, 80000, 76000, 70000, 70000, 70000, 85000, 50000, 45000)
# Actual = c(74654, 73311, 56424, 58238, 69926, 69987, 69933, 84995, 53716, 22491)
# Year = 2009:2018
# total_arrival_df = data.frame(ceiling, actual, year)

total_arrival_df$Ceiling = Ceiling

total_arrival_df <- total_arrival_df %>%
  gather(key, Individuals, Actual, Ceiling)

total_arrival_df$Events = c("
-Barack Obama is inaugurated.
-In Cairo, President Obama addresses the 
world's Muslims, vowing to forge a 'new beginning'.
US forces pull out of Iraq's main cities and towns.", '
-The long war in Iraq was officially declared over
-Unemployment rate rose to 9.8%
-The Arizona Immigration Law', '\nUS forces killed the al-Qaida leader, Osama Bin Laden', '
-Gay marriage made legal
-Facebook IPO
-U.S. general election where democratic Obama beat Republican 
rival Mitt Romney to win a second term in the White House', '
-Detroit filed for bankruptcy 
-Unable to reach agreement on federal spending levels, 
a dysfunctional Congress stumbled into the first government 
shutdown since the mid-1990s', '
-U.S. air attacks against ISIS forces in Iraq and Syria began in August
-U.S. - Cuba thaw after Alan Gross was freed after 5 years', '
-President Obama’s plan to allow 10,000 Syrian refugees into 
the U.S was met with stiff resistance from some House Republicans', '\n-Donald Trump elected as the next U.S. president
-Flint, Michigan water crisis', '
-Donald Trump is inaugurated as the 45th president of the U.S.
-American tensions with North Korea intensified
-Devastating hurricane season in southeast Texas and Florida', '
-In California, wildfires left 88 dead in the massive Camp Fire
-Migrant children were separated from their parents as part 
of President Trump’s ‘zero tolerance’ border policy', "
-Barack Obama is inaugurated.
-In Cairo, President Obama addresses the 
world's Muslims, vowing to forge a 'new beginning'.
US forces pull out of Iraq's main cities and towns.", '
-The long war in Iraq was officially declared over
-Unemployment rate rose to 9.8%
-The Arizona Immigration Law', '\nUS forces killed the al-Qaida leader, Osama Bin Laden', '
-Gay marriage made legal
-Facebook IPO
-U.S. general election where democratic Obama beat Republican 
rival Mitt Romney to win a second term in the White House', '
-Detroit filed for bankruptcy 
-Unable to reach agreement on federal spending levels, 
a dysfunctional Congress stumbled into the first government 
shutdown since the mid-1990s', '
-U.S. air attacks against ISIS forces in Iraq and Syria began in August
-U.S. - Cuba thaw after Alan Gross was freed after 5 years', '
-President Obama’s plan to allow 10,000 Syrian refugees into 
the U.S was met with stiff resistance from some House Republicans', '\n-Donald Trump elected as the next U.S. president
-Flint, Michigan water crisis', '
-Donald Trump is inaugurated as the 45th president of the U.S.
-American tensions with North Korea intensified
-Devastating hurricane season in southeast Texas and Florida', '
-In California, wildfires left 88 dead in the massive Camp Fire
-Migrant children were separated from their parents as part 
of President Trump’s ‘zero tolerance’ border policy')

p <-ggplot(total_arrival_df, aes(x=Year, y=Individuals, colour=key, label=Events)) +
      geom_line() +
      geom_point(size = .75) +
      geom_vline(xintercept = 2016, color='gray') +
      annotate("text", x=2015.3, y =50000, label="Trump\nelected", color='gray', hjust=0) +
      geom_vline(xintercept = 2012, color='gray') +
      annotate("text", x=2011.2, y =40000, label="Obama\nreelected", color='gray', hjust=0) +
      ylab("Number of Individuals") +
      ggtitle('Ceilings Vs Actual Refugee Resettlements') +
      scale_y_continuous(labels = comma) +
      theme(plot.title=element_text(hjust=0.5))

ggplotly(p, tooltip = c('y', 'label'))
```

Looking at the general trend of change in refugee admission ceiling, the two timepoints that stand out the most are 2015 and 2016.
  * In 2015, the refugee admission ceiling increased drastically from 70,000 to a record high of 85,000 in 2016 under President Obama’s administration. 
  * In 2016, however, the refugee admission ceiling decreased drastically from 85,000 to a record low of 45,000 in 2018 under President Trump’s administration and has continued to decrease.

Looking at the general trend of change in the actual refugee resettlement population, we can see that the population decreased from 79,943 in 2009 to a low of 51,458 in 2011, when President Obama was re-elected. 
However, the resettlement population increased from 51,458 in 2011 to a record high of 96,874 in 2016, and decreased drastically from 96,874 in 2016 to a record low of 22,847 in 2018 under President Trump’s administration.


We take a closer look at the top 5 countries that have refugees resettled in the USA (https://data.newamericaneconomy.org/en/refugee-resettlement-us/).

```{r}
total_demo <- ethnicity_df
total_demo$Total <- as.numeric(total_demo$Total)
change_in_pop <- total_demo %>%
  group_by(Year, country) %>%
  summarize(sum=sum(Total))

change_in_pop$Events <- c('\n-A 6.1 magnitude earthquake occurred in eastern 
Bhutan, leaving at least 10 dead
-Huanglongbing virus wipes out much of Bhutan’s 
orange crop, an important export for Bhutan', "\n- Government signs ceasefire with rebels 
of Karen ethnic group.
- Myanmar abolishes pre-publication 
media censorship.", '\nEastern Congo offensive - a joint Congo-Rwanda military 
offensive against the Hutu FDLR rebel group descended from 
those groups that carried out the 1994 Rwanda genocide.', '\n-US hands over responsibility for 
security in the Green Zone to Iraqi forces 
- lowest monthly death toll since the
US-led invasion of March 2003
- several car bombings ', '\n-Multiple hijacking by Somali pirates
-Oxfam International describes the 
humanitarian crisis in Somalia as "very dire".', '\nAlthough Bhutan saw a decline in annual tourism 
revenues and a loss of over $67 million due to 
earthquake and cyclone damages', "\n- Government changes country's flag, 
national anthem and official name.", '\nThe UN renewed sanctions on the DRC which 
included guidelines for importers, processors and 
consumers buying Congolese minerals, which are the 
source of funding for many rebel groups.', '\n-Parliamentary election: secular, non-sectarian 
Iraqi National Movement received the most votes 
-President Obama announced that US combat 
operations in Iraq will end Aug 31', 'Ongoing Somali Civil War', '\nKing Jigme Khesar Namgyel Wangchuck marries 
21-year-old student Jetsun Pema', '\n- Thein Sein is sworn in as president 
of a new, nominally civilian government.
- US Secretary of State Hillary Clinton 
visits, meets Aung San Suu Kyi and President Thein Sein', '\nPresidential and parliamentary elections. Mr Kabila 
gains another term. The vote is criticised abroad and 
the opposition disputes the result.', 'War officially ended', '\n-East Africa Drought
-Somalia Famine', '\nPolitical leaders enforced a nearly six-month 
ban on all public religious activities ahead 
of the upcoming elections', '\n- Government signs ceasefire with rebels 
of Karen ethnic group.
- Myanmar abolishes pre-publication 
media censorship.', '\nThe Child Protection Law of 2009 sets the minimum age 
for full-time work at 18, unless a parent consents', 'Ongoing explosions, suicide bombings', 'Somali presidential election', '\nParliamentary elections: opposition People’s Democratic 
Party wins 32 seats in the lower house, against the 
incumbent Druk Phuensum Tshogpa party’s 15 seats.', '\n- Rioting between Muslims and Buddhists in 
Meiktila leaves at least 10 people dead.
- Four private daily newspapers appear for the 
first time in almost 50 years as the state monopoly ends.', '\n- Representatives of 11 African countries sign an 
accord pledging to help end the conflict in DR Congo. 
- 3,000-member UN Intervention Brigade deployed to 
fight and disarm rebels in the east.', '\nIraqi protests (Iraqi Insurgency/Iraq Crisis : 
violent conflict with the central government & 
sectarian violence among religious groups)', 'NA', '\nThe World Bank Group’s Senior Vice President and 
Chief Economist, Kaushik Basu, visited Bhutan to learn 
from the country’s unique development experience as the 
country makes rapid progress in reducing poverty.', '\n- US extends some sanctions for another year, 
saying that despite the recent reforms, rights abuses 
and army influence on politics and the economy persist.', '\nThe Democratic Republic of Congo confirms two deaths 
from Ebola in the north of the country, the first 
cases reported from the current outbreak in West Africa', '\nBeginning of Iraqi Civil War & ISIS militants 
control the Iraqi cities & Northern Iraq offensive', '\nThe Somali government-led Operation Indian 
Ocean was launched to clean up the remaining 
insurgent-held pockets in the countryside', '\nJohn Kerry becomes the first-ever US secretary of state 
to hold a cabinet-level meeting with a Bhutanese official 
when he meets Bhutanese Prime Minister Tshering Tobgay in India', '\n- A draft ceasefire agreement is signed between 
the government and 16 rebel groups.
\n- Hundreds of Muslim Rohingyas migrants leave 
by sea in flimsy boats.
\n- Opposition National League for Democracy, 
led by Aung San Suu Kyi, wins enough seats in 
parliamentary elections to form a government.', '\nDozens killed in protests against proposed electoral 
law changes which the opposition said were designed 
to allow President Kabila to remain in power.', '\nISIL -> destruction of Mosul Museum, bombings in 
Baghdad, destruction of the city of Hatra, Nimrud, 
and Bash Tapia Castle', '\nAMISOM and Somalia National Army regained many 
villages and major towns of Baardhere and Dinsoor', '\nKing Jigme Khesar Namgyel Wangchuck and his wife, Queen Jetsun 
Pema announce the birth of Crown Prince Jigme Namgyal Wangchuck', "\n- Htin Kyaw sworn in as president, ushering in a 
new era as Aung San Suu Kyi's democracy movement takes 
power after 50 years of military domination.", "\nA political deal signed between President Kabila's 
ruling coalition and the opposition to delay the 
presidential election until 2018 sees Prime Minister 
Augustin Matata Ponyo and his cabinet resign, paving 
the way for a new cabinet to include opposition figures.", '\nIslamic State attacked and briefly seized 
an Iraqi army base in Al Tarah', '\nDrought', '\nBhutan protests to China over its building of a 
road in disputed territory', '\n- The United Nations human rights council decides 
to set up an investigation into alleged human rights abuses 
by the army against the Rohingya Muslim minority.', '\nDR Congo is experiencing a "mega-crisis", with conflict 
having forced 1.7 million people to flee their homes 
during the year, aid agencies say.', '\n-Iraqi government official threat to Kurdish to 
close a border in Northern Iraq follow vote for 
independence referendum
-Ongoing suicide car bombings ', '\nMogadishu bombings', 'NA', '\n- President Htin Kyaw resigns on health grounds 
and is replaced by Win Myint, a fellow Suu Kyi loyalist.', '\n- Main opposition Union for Democracy and Social 
Progress chooses Felix Tshisekedi as its candidate 
for the December presidential election.
- Ebola outbreak in the east.', 'Baghdad bombings (two suicide bombings)', '\n-Mogadishu attack
-Cyclone Sagar makes landfall ')
countries_plot <- ggplot(change_in_pop, aes(Year, sum, color=country, label=Events))+
  geom_line() + 
  geom_point(size = .75) +
  xlab("Year") + 
  ylab("Number of Individuals") +
  labs(title = "Change in Refugee Resettlement to the US \nof Top 5 Refugee Origins from 2009-2018 ",
       caption = "Figure: Times series graph of top 5 refugee origins with the most number refugee resettlements.") +
  theme(legend.title = element_blank(), plot.title=element_text(hjust=0.5))

ggplotly(countries_plot, tooltip = c('y', 'label'))
```

## Geographical Analysis

```{r, fig.width=9}
df_map <- arrival_df

# remove extra 6 'States'
df_map <- df_map[!df_map$State %in% c('American Samoa', 'District of Columbia', 'Guam', 'Puerto Rico', 'Unknown State', 'Virgin Islands'), ]
df_map$State <- as.factor(df_map$State)
df_map$code <- state.abb[match(df_map$State, state.name)]

#add Wyoming and Montana because they are misisng 
df_add <- data.frame(State = c('Wyoming','Wyoming','Montana'), Cases = c(0, 0, 0), Inds = c(0, 0, 0), Year = c(2009, 2010, 2010), code = c('WY', 'WY', 'MT'))

df_map <- rbind(df_map, df_add)

df_map$State <- tolower(df_map$State)

states <- map_data('state')

# fill = Inds? or cases?
map_basic <- ggplot(df_map, aes(map_id = State)) + 
  geom_map(aes(fill = Inds), map = states) + 
  expand_limits(x = states$long, y = states$lat) +
  facet_wrap(~Year) +
  scale_fill_gradient(low="#D6EAF8", high="#154360") +
  ggtitle('Refugee Resettlement in the US by State') +
  theme(plot.title=element_text(hjust=0.5))

map_basic
```


## Demographic Analysis

### Religion

The top 5 religions in the world are: Christianity, Islam, Hinduism, Buddhism, Sikhism (https://thecountriesof.com/top-5-largest-religions-in-the-world/). In Iraq, they separate the Muslim population into three categories: Muslim, Muslim Shiite, and Muslim Suni. For the purposes of this analysis, we will combine them as one.

```{r, fig.height=7}
muslim_names = c('Moslem', 'Moslem Suni', 'Moslem Shiite')

religion_df3 <- religion_df %>% 
  group_by(Year, Religion) %>%
  summarise(Inds = sum(Male) + sum(Female)) %>%
  mutate(Proportion = Inds / sum(Inds))

# rename to Moslem
religion_df3[religion_df3$Religion %in% muslim_names, 'Religion'] <- 'Moslem'

innerFunc <- function(sub_df){
  row <- head(sub_df, 1)
  row$Inds <- sum(head(sub_df$Inds))
  return(row)
}

religions = c('Christian', 'Moslem', 'Buddhist', 'Hindu')
subset_religion_df3 <- religion_df3[religion_df3$Religion %in% religions, ]

# combines Moslem for each year
create_religion_df <- function(current_df) {
  df <- do.call(rbind,
                  by(data=current_df[current_df$Year==2009, ],
                     INDICES=current_df[current_df$Year==2009, ]$Religion, FUN=innerFunc))
    
  for (year in c(2010:2018)) {
    df2 <- do.call(rbind,
                   by(data=current_df[current_df$Year==year, ],
                     INDICES=current_df[current_df$Year==year, ]$Religion, FUN=innerFunc))
    df <- rbind(df, df2)
}
  
  return(df)
}

subset_religion_df4 <- create_religion_df(subset_religion_df3)

subset_religion_df4$Religion <- factor(subset_religion_df4$Religion, levels = c('Christian','Moslem','Hindu', 'Buddhist'))

p2 <- ggplot(subset_religion_df4, aes(x= reorder(Religion, -Proportion), y=Proportion, fill=Religion)) + 
  geom_bar(stat="identity") +
  facet_grid(subset_religion_df4$Year) +
  labs(x = 'Religion', y = 'Proportion') +
  scale_x_discrete(labels = c('Christian','Muslim','Hindu', 'Buddhist')) +
  ggtitle('Religion Over Time') +
  theme(legend.position = 'none', plot.title=element_text(hjust=0.5))
p2
```

### Education Level

```{r}
edu_df<- select(filter(education_df, Education != "Bio Data not Complete" & Education != "Unknown"),c(Education,Total, country, Year))

edu_country <- edu_df %>% 
  group_by(country) %>%
  mutate(proportion = Total/sum(Total))

ggplot(edu_country, aes(x= reorder(Education, - proportion),y=proportion, fill=Education))+
  geom_bar(stat="identity") +
  facet_grid(edu_country$country) +
  labs(x='Education Level', y='Proportion') +
  theme(legend.position="none", plot.title=element_text(hjust=0.5), axis.text.x = element_text(angle = 90, hjust = 1)) +
  ggtitle("Education Data by Country")
```

### Age Group

```{r}
age_df2 <- age_df %>% 
  group_by(country) %>%
  mutate(Proportion = Total/sum(Total))

age_df2$Age.Group <- factor(age_df2$Age.Group, levels = c("Under 14", "Age 14 to 20", "Age 21 to 30", "Age 31 to 40", "Age 41 to 50", "Age 51 to 64", "Age 65 and Over"))

p3 <- ggplot(age_df2, aes(x= Age.Group, y=Proportion, fill=Age.Group)) + 
  geom_bar(stat="identity") +
  facet_grid(age_df2$country) +
  labs(x = 'Age Group', y = 'Proportion') +
  theme(legend.position="none", plot.title=element_text(hjust=0.5)) +
  ggtitle('Age Group by Country')

p3
```

DRC and Somalia have the highest proportions of refugees who are under 14.


# Interactive Component

## Geographics
```{r}
# remove extra 6 'States'
arrival_df2 <- arrival_df[!arrival_df$State %in% c('American Samoa', 'District of Columbia', 'Guam', 'Puerto Rico', 'Unknown State', 'Virgin Islands'), ]
arrival_df2$State <- as.factor(arrival_df2$State)
arrival_df2$code <- state.abb[match(arrival_df2$State, state.name)]

gg <- ggplot(arrival_df2, aes(code, Inds, frame = Year)) + 
  geom_bar(stat="identity", position='identity') +
  labs(x = "State", y="Individuals") +
  ggtitle('Refugee Resettlements By State from 2009-2018') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1), plot.title=element_text(hjust=0.5))
ggplotly(gg)
```

## Demographics: Religion

```{r} 

# Line Chart with Drop-down menu for Hindu and Muslim by Country 
muslim_names = c('Moslem', 'Moslem Suni', 'Moslem Shiite')

religion_df5 = religion_df
religion_df5[religion_df5$Religion %in% muslim_names, 'Religion'] <- 'Moslem'

religions_2 = c('Moslem', 'Hindu')
subset_religion_df5 <- religion_df5[religion_df5$Religion %in% religions_2, ]

subset_religion_df5 <- subset_religion_df5 %>% group_by(Year, Religion, country,) %>% summarise(Total = sum(Male)+sum(Female))

```


```{r}

#Absolute Number Calculation
hindu_df <- filter(subset_religion_df5, Religion == 'Hindu') 
hindu_df_messy <- spread(hindu_df, country, Total)

muslim_df <- filter(subset_religion_df5, Religion == 'Moslem')
muslim_df_messy <- spread(muslim_df, country, Total)
drop <- c('Bhutan')
muslim_df_messy <- muslim_df_messy[, !names(muslim_df_messy) %in% drop]

# Percent Calculation
religion_df6 = religion_df
religion_df6[religion_df6$Religion %in% muslim_names, 'Religion'] <- 'Moslem'

religion_df6 <- religion_df6 %>% 
  group_by(Year, Religion, country) %>%
  summarise(Inds = sum(Male) + sum(Female)) %>%
  mutate(Proportion = Inds / sum(Inds))

hindu_percent_df <- filter(religion_df6, Religion == 'Hindu') %>%
  select(Year, Religion, country, Proportion) %>%
  spread(country, Proportion)

muslim_percent_df <- filter(religion_df6, Religion == 'Moslem') %>%
  select(Year, country, Religion, Proportion) %>%
  spread(country, Proportion)

muslim_percent_df <- muslim_percent_df[, !names(muslim_percent_df) %in% c('Bhutan')]

setnames(hindu_percent_df, old=c("Bhutan","Burma"), new=c("Bhutan_Percentage", "Burma_Percentage"))
setnames(muslim_percent_df, old=c("Burma", "DRC", "Iraq", "Somalia"), new=c("Burma_Percentage", "DRC_Percentage", "Iraq_Percentage", "Somalia_Percentage"))

hindu_df_messy_final <- merge(hindu_df_messy, hindu_percent_df, by = c("Year", "Religion"))
muslim_df_messy_final <- merge(muslim_df_messy, muslim_percent_df, by = c("Year", "Religion"))
```

```{r}

BLUE = 'rgb(26, 118, 255)'

p_hindu_dropdown <- plot_ly(hindu_df_messy_final, x = ~Year) %>%
  add_bars(y = ~Bhutan, name = 'Bhutan', marker= list(color='orange')) %>%
  add_bars(y = ~Burma, name = 'Burma', marker= list(color=BLUE)) %>%
  add_bars(y = ~Bhutan_Percentage, name = 'Bhutan Proportion', marker= list(color='orange'), visible=F) %>%
  add_bars(y = ~Burma_Percentage, name = 'Burma Proportion', marker= list(color=BLUE), visible=F) %>%
  layout(
    title = 'Hindus by Country Over Time', 
    xaxis = list(domain = c(2009, 2018)), 
    yaxis = list(title = 'Hindu'),
    updatemenus = list(
      list(
            x = 1.4,
            y = 0.7,
            buttons = list(
              list(method = 'restyle',
                   args = list('visible', list(TRUE, TRUE, F, F)),
                   label = 'All Individuals'),
              list(method = 'restyle',
                   args = list('visible', list(TRUE, FALSE, FALSE, FALSE)),
                   label = '\t\t\tHindus from Bhutan'),
              list(method = 'restyle',
                   args = list('visible', list(FALSE, TRUE, FALSE, FALSE)),
                   label = '\t\t\tHindus from Burma'), 
              list(method = 'restyle',
                   args = list('visible', list(F, F, T, T)),
                   label = 'All Proportions'),
              list(method = 'restyle',
                   args = list('visible', list(FALSE, FALSE, TRUE, FALSE)),
                   label = '\t\t\tHindus from \n\t\t\tBhutan in Proportions'),
              list(method = 'restyle',
                   args = list('visible', list(FALSE, FALSE, FALSE, TRUE)),
                   label = '\t\t\tHindus from \n\t\t\tBurma in Proportions'))
      )
      
    )
  )

RED = 'rgb(255, 99, 71)'
GREEN = 'rgb(60, 179, 113)'
PURPLE = 'rgb(218, 112, 214)'

p_muslim_dropdown <- plot_ly(muslim_df_messy_final, x = ~Year) %>%
  add_bars(y = ~Burma, name = 'Burma', marker= list(color=BLUE)) %>%
  add_bars(y = ~DRC, name = 'DRC', marker= list(color=PURPLE)) %>%
  add_bars(y = ~Iraq, name = 'Iraq', marker= list(color=GREEN)) %>%
  add_bars(y = ~Somalia, name = 'Somalia', marker= list(color=RED)) %>%
  add_bars(y = ~Burma_Percentage, name = 'Burma Proportion', marker= list(color=BLUE), visible=F) %>%
  add_bars(y = ~DRC_Percentage, name = 'DRC Proportion', marker= list(color=PURPLE), visible=F) %>%
  add_bars(y = ~Iraq_Percentage, name = 'Iraq Proportion', marker= list(color=GREEN), visible=F) %>%
  add_bars(y = ~Somalia_Percentage, name = 'Somalia Proportion', marker= list(color=RED), visible=F) %>%
  layout(
    title = 'Muslims by Country Over Time', 
    xaxis = list(domain = c(2009, 2018)), 
    yaxis = list(title = 'Muslim'),
    updatemenus = list(
      list(
            x= 1.4,
            y = 0.6,
            buttons = list(
              list(method = 'restyle',
                   args = list('visible', list(TRUE, TRUE, TRUE, TRUE, F, F, F, F)),
                   label = 'All Individuals'),
              list(method = 'restyle',
                   args = list('visible', list(TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE)),
                   label = '\t\t\tMuslims from Burma'),
              list(method = 'restyle',
                   args = list('visible', list(FALSE, TRUE, FALSE, FALSE, FALSE, FALSE,FALSE, FALSE)),
                   label = '\t\t\tMuslims from DRC'),
              list(method = 'restyle',
                   args = list('visible', list(FALSE, FALSE, TRUE, FALSE, FALSE, FALSE, FALSE, FALSE)),
                   label = '\t\t\tMuslims from Iraq'),
              list(method = 'restyle',
                   args = list('visible', list(FALSE, FALSE, FALSE, TRUE, FALSE, FALSE, FALSE, FALSE)),
                   label = '\t\t\tMuslims from Somalia'),
              list(method = 'restyle',
                   args = list('visible', list(F, F, F, F, TRUE, TRUE, TRUE, TRUE)),
                   label = 'All Proportions'),
              list(method = 'restyle',
                   args = list('visible', list(FALSE, FALSE, FALSE, FALSE, TRUE, FALSE, FALSE, FALSE)),
                   label = '\t\t\tMuslims from \n\t\t\tBurma in Proportions'),
              list(method = 'restyle',
                   args = list('visible', list(FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, FALSE, FALSE)),
                   label = '\t\t\tMuslims from \n\t\t\tDRC in Proportions'),
              list(method = 'restyle',
                   args = list('visible', list(FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, FALSE)),
                   label = '\t\t\tMuslims from \n\t\t\tIraq in Proportions'),
              list(method = 'restyle',
                   args = list('visible', list(FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, TRUE)),
                   label = '\t\t\tMuslims from \n\t\t\tSomalia in Proportions'))
        )
      )
    )



p_hindu_dropdown 

p_muslim_dropdown
```

# Conclusion

**TODO: WRITE STUFF**

