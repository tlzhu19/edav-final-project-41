---
title: "Refugee Resettlements in the USA"
author: "Ji In Choi (jic2124), Jung Ah Shin (js5569), Olivia Wang (yw3324), Tiffany Zhu (tz2196)"
date: "December 12, 2019"
output:
  html_document:
    toc: true
    toc_float: true
    theme: journal
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(readxl)
library(tidyverse)
library(plotly)
library(knitr)
library(scales)
```

# Introduction
## Motivation
The world’s forcibly displaced population hit its record high in 2017. Globally, at the end of 2017, the global refugee population increased by 2.9 million. By the end of the year, 68.5 million individuals were forcibly displaced worldwide as a result of persecution conflict, or generalized violence (https://www.unhcr.org/5b27be547.pdf). Despite the increase in demand for refugee admission and assistance, the United States specifically has taken a drastic turn away from supporting refugees. The number of refugees admitted to the United States has dropped from a recent high of 84,994 in FY 2016 to 22,874 in FY 2018 - the lowest in 40 years since 1977. The current ceiling for refugee admission has also dropped to 45,000, the lowest in the history of the current US resettlement program. Coming at a time when global numbers of refugees have reached record highs, the ratio of refugees admitted to the United States to the number of refugees worldwide has never been lower. For the first time, the US policy towards refugee admission is moving decisively against the trend of the total number of refugees worldwide (https://www.cgdev.org/blog/reflecting-world-refugee-day-trends-and-consequences-us-refugee-policy). 
The recent years thus mark a significant shift in refugee resettlement in the US, as a result, this report will be examining the refugee admission trend in the US over the past 10 years (2009-2018). 

## Background 
According to the UNHCR, refugees are defined as those who have been forced to leave their country due to violence, war, or persecution based on their race, religion, nationality, political opinion or particular social group. 

Process of refugee resettlement:
  
  1. The process of refugee resettlement to the U.S. is a lengthy and thorough process that takes approximately two years and involves numerous U.S. governmental agencies
  
  2. Refugees do not choose the country in which they would like to live. UNHCR, the UN Refugee Agency identifies the most vulnerable refugees for resettlement and then makes recommendations to select countries.
  
  3. Once a refugee is recommended to the U.S. for settlement, the U.S. government conducts a thorough vetting of each applicant. The process of which takes between 12 to 24 months and includes:
      * Screening by 8 federal agencies including the State Department, Department of Homeland Security and the FBI
      * Six security database checks and biometric security checks screened against U.S. federal databases
      * Medical screening
      * Three in-person interviews with Department of Homeland Security Officers

Under the Refugee Act of 1980, the president sets an annual ceiling for refugee admissions in consultation with Congress. The annual ceiling has varied over the years, from a high of 231,700 in FY 1980 to a prior low of 67,000 in FY 1986. Amid a large exodus of Syrinas from their war-torn country, President Obama raised the refugee ceiling for FY 2016 to 110,000. After taking office, Trump reduced the FY 2017 cap to 50,000, and for FY 2018 set one at a historic low of 45,000. Far fewer refugees, 22,874, were actually resettled in FY 2018.


## Questions
There are currently 25.9 million refugees in the world, indicating the dramatic growth in refugees over the past decade. This led us to question what the refugee resettlement trend has been for the past decade, and delve deeper than just the changes in the numbers of refugees. In order to better visualize the trend of refugee resettlement to the US, this report will be specifically focusing on the top 5 countries (Burma, Iraq, Somalia, Bhutan, Democratic Republic of the Congo) with the highest refugee resettlement population in the US, which accounted for 60.9% of the total refugee arrivals in the US (https://data.newamericaneconomy.org/en/refugee-resettlement-us/).

We are interested in answering the following questions to gain a better understanding of the refugee resettlements in the United States:
  
  1. What insights can we gain from temporal exploratory data analysis of refugee settlement patterns in the US?
      * Has there been increases/decreases in refugee resettlements population from 2009 - 2018?
      * Is there a correlation between change in refugee resettlement population and major political events that have happened over the 10 years?

  2. What insights can we gain from geographical visualization of refugee settlement patterns in the US over the 10 years? Why might some states have larger refugee settlements than others?
  
  3. What changes in demographic patterns (i.e., religion, gender, age, etc.) within the refugee population over the 10 years can we visualize? Can we observe any relationship between certain demographics and refugee settlements?
      * Given the number of religions included in the refugee population, we will be focusing on the top 5 religions in the world (Christianity, Islam, Hinduism, Buddhism, Sikhism). In Iraq, they separate the Muslim population into three categories: Muslim, Muslim Shiite, and Muslim Suni. For the purposes of this analysis, we will combine them as one (https://thecountriesof.com/top-5-largest-religions-in-the-world/).


# Data Sources

We first collected data from RPC (Refugee Processing Center), that provides refugee arrival information by state and nationality, by destination and nationality, by nationality and religion, and by demographic profile. 

We can select the time frame, nationality. 
Since the RPC website does not allow for faceting by year, we had to download the files year by year, and clean the data into the format we want for data analysis.


# Data Transformation
## Cleaning the Data in R

1. From the website, we were able to download '.xlsx' files. Raw files can be found [here](https://github.com/tlzhu19/edav-final-project-41/tree/master/data/raw).
2. Wrote two functions to clean Excel sheet for a given year. 
    i. `clean_arrival` to clean the Excel files for all refugee resettlements for each state.
    ii. `clean_demographics` to clean the Excel files for demographic information for refugees from specific countries (namely Bhutan, Burma, DRC, Iraq, and Somalia).
3. Wrote another function, `combine_files`, to combine each year's Excel file into one.
4. Saved these as csv files and uploaded to GitHub to easily access.

```{r}
# Used to clean the Arrivals data
clean_arrival <- function(file, sheet_name) {
  dat <- read_excel(file, sheet = sheet_name)
  dat1 <- subset(dat, select = c(...6, ...8,...9))
  dat2 <-subset(dat, select = c(...15,...18,...19)) 
  dat3 <-subset(dat, select = c(...23,...25,...27))

  dat1<-dat1 %>% drop_na()
  dat2<-dat2 %>% drop_na()
  dat3<-dat3 %>% drop_na()

  # set first row (State, Cases, Inds) as column name
  colnames(dat1) <- as.character(unlist(dat1[1,]))
  dat1 = dat1[-1, ]
  colnames(dat2) <- as.character(unlist(dat2[1,]))
  dat2 = dat2[-1, ]
  colnames(dat3) <- as.character(unlist(dat3[1,]))
  dat3 = dat3[-1, ]

  # Grouping columns together
  combined <- rbind(dat1,dat2)
  combined <- rbind(combined,dat3)

  # State,Cases,Inds

  combined$Cases <-as.numeric(as.character(combined$Cases))
  combined$Inds <-as.numeric(as.character(combined$Inds))
  
  return (combined)
}


```

```{r}
# Used to clean the Demographics data
clean_demographics <- function(file, sheet_name) {
  df <- read_excel(file, sheet = sheet_name)
  
  if (sheet_name == 'Age Group') {
    column_names = c('Department of State','...2', '...3', '...4')
  }
  else if (sheet_name == 'Religion') {
    column_names = c('Department of State','...2', '...4', '...6')
  }
  else if (sheet_name == 'Ethnicity' | sheet_name == 'Education' | sheet_name == 'Native Language') {
    column_names = c('Department of State','...2', '...3', '...5')
  }
  
  df2 <- subset(df, select = column_names)
  df3 <- df2[complete.cases(df2), ]
  df4 = df3[-nrow(df3), ]
  
  #print(file)
  #file_replaced <- gsub(pattern="demographics/", replacement=".", file, fixed = TRUE)
  
  # file_unpacked <- unlist(strsplit(file_replaced, split='.', fixed=TRUE))
  file_unpacked <- unlist(strsplit(file, 'demographics/'))
  file_unpacked2 <- unlist(strsplit(file_unpacked[2], '_Demographics'))
  country_name = file_unpacked2[1]

  colnames(df4) = c(sheet_name, 'Male', 'Female', 'Total')
  
  df4$country <- rep(country_name, nrow(df4))
  
  return(df4)
}

```

```{r}
# Cleans and combines all the files in the directory given by path
combine_files <- function(path, data_cleaner, sheet_name, title) {
  df = data.frame()
  files <- list.files(path=path, pattern="*.xlsx", full.names=TRUE, recursive=FALSE)
  for (file in files){
    cleaned_data = data_cleaner(file, sheet_name)
    year_extract <- unlist(strsplit(file, title))
    cleaned_data$Year <- as.numeric(gsub(".xlsx", "", year_extract[2]))
    df <- rbind(df, cleaned_data)}
  return (df)
}
#Examples

# path = "~/Desktop/Projects/EDAV/edav-final-project-41/data/raw/demographics"
# title = 'Demographics_'
# function
# sheet_name = 'Ethnicity'
# sheet_name = 'Age Group'
# sheet_name = 'Religion'
# sheet_name = 'Education'
# sheet_name = 'Native Language'
# data_cleaner = clean_demographics

# path = "~/Desktop/Projects/EDAV/edav-final-project-41/data/raw/all_arrivals"
# title = 'Arrivals_'
# sheet_name = 'Detailed'
# data_cleaner = clean_arrival

# df_test3 <- combine_files(path, clean_demographics, sheet_name, title)
```

```{r}
# Cleaned all_arrivals data converted to csv files
save_cleaned_all_arrivals <- function(path) {
    read_path = paste(path, "/edav-final-project-41/data/raw/all_arrivals", sep='')
    write_path = paste(path, "/edav-final-project-41/data/clean", sep='')
    title = 'Arrivals_'
    sheet_name = 'Detailed'
    data_cleaner = clean_arrival
    arrival_df <- combine_files(read_path, data_cleaner, sheet_name, title)
    write.csv(arrival_df, file = paste(write_path, "all_arrivals.csv", sep=''), row.names = FALSE)
}

# Cleaned demographics data converted to csv files
save_cleaned_all_demographics <- function(path) {
  read_path = paste(path, "/edav-final-project-41/data/raw/demographics", sep='')
  write_path = paste(path, "/edav-final-project-41/data/clean", sep='')
  title = 'Demographics_'
  sheet_names = c('Ethnicity', 'Age Group', 'Religion', 'Education', 'Native Language')
  file_names = c('ethnicity', 'age_group', 'religion', 'education', 'native_language')
  data_cleaner = clean_demographics
  
  for (i in 1:length(sheet_names)) {
    demographic_df <- combine_files(read_path, data_cleaner, sheet_names[i], title)
    file_name = paste(write_path, file_names[i], sep='')
    write.csv(demographic_df, file = paste(file_name, '.csv', sep=''), row.names = FALSE)
  }
}
```

## Cleaned Data Format
```{r}
# Read cleaned data from github
arrival_df = read.csv('https://raw.githubusercontent.com/tlzhu19/edav-final-project-41/master/data/clean/all_arrivals.csv')
age_df = read.csv('https://raw.githubusercontent.com/tlzhu19/edav-final-project-41/master/data/clean/age_group.csv')
ethnicity_df = read.csv('https://raw.githubusercontent.com/tlzhu19/edav-final-project-41/master/data/clean/ethnicity.csv')
religion_df = read.csv('https://raw.githubusercontent.com/tlzhu19/edav-final-project-41/master/data/clean/religion.csv')
education_df = read.csv('https://raw.githubusercontent.com/tlzhu19/edav-final-project-41/master/data/clean/education.csv')
native_language_df = read.csv('https://raw.githubusercontent.com/tlzhu19/edav-final-project-41/master/data/clean/native_language.csv')
```

After cleaning the data, we have six '.csv' files that can be found [here](https://github.com/tlzhu19/edav-final-project-41/tree/master/data/clean). 

1. `all_arrivals.csv`: The total number of refugee resettlements to each of the 50 states in the US from 2009-2018. All raw files to make this file can be found [here](https://github.com/tlzhu19/edav-final-project-41/tree/master/data/raw/all_arrivals).
```{r}
kable(head(arrival_df))
```

2. `age_group.csv`: 
```{r}
kable(head(age_df))
```

3. `education.csv`: 
```{r}
kable(head(education_df))
```

4. `ethnicity.csv`: 
```{r}
kable(head(ethnicity_df))
```

5. `native_language.csv`: 
```{r}
kable(head(native_language_df))
```

6. `religion.csv`: 
```{r}
kable(head(religion_df))
```

## Transforming the Data

**WRITE STUFF**

# Missing Values
The datasets from RPC (Refugee Processing Center) did not contain any missing values. However, we also noticed that our data contained a single row called “Unknown State”. Since this would not be plotted in our maps, we decided that it would be better to remove the data. Additionally, when we converted the `State` column to factors, there were 56. The extra 6 states are:

* American Samoa
* District of Columbia
* Guam
* Puerto Rico
* Unknown State
* Virgin Islands

We removed these rows since we are just curious about the fifty states.

In Education data, we observed the proportion of missing data compared to the total data. 

```{r}
# CODE FOR PLOTTING PERCENTAGE OF MISSING DATA 
na_df<- select(filter(education_df, Education == "Bio Data not Complete" | Education == "Unknown"),c(Education,Total, country, Year))
# Total sum of data 
total_df <- education_df %>% group_by(country)%>% summarize(Total = sum(Total))
# Total sum of missing data
na_df <- na_df %>% group_by(country) %>% summarize(Total = sum(Total))
# Change column name 
names(na_df)[2] <- "na_Total"
# Put two df together
combine_df <- cbind(total_df,na_df[2])
# Proportion of missing data 
combine_df <- transform(final, proportion = na_Total/Total)
# Plot missing data
ggplot(final, aes(x=country, y=proportion, fill=country))+
  geom_bar(stat="identity")+
  theme(legend.position="none", plot.title=element_text(hjust=0.5))+
  ggtitle("Missing Education Data by Country")
```


# Results


```{r}
# Compare ceilings with actual admissions
total_arrival_df <- arrival_df %>%
  group_by(Year) %>%
  summarise(Actual = sum(Inds))

# data from https://www.migrationpolicy.org/article/refugees-and-asylees-united-states#Refugee_Admission_Ceiling
Ceiling = c(80000, 80000, 80000, 76000, 70000, 70000, 70000, 85000, 50000, 45000)
# Actual = c(74654, 73311, 56424, 58238, 69926, 69987, 69933, 84995, 53716, 22491)
# Year = 2009:2018
# total_arrival_df = data.frame(ceiling, actual, year)

total_arrival_df$Ceiling = Ceiling

total_arrival_df <- total_arrival_df %>%
  gather(key, Individuals, Actual, Ceiling)

total_arrival_df$events = c('blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah')

p <-ggplot(total_arrival_df, aes(x=Year, y=Individuals, colour=key, label=events)) +
      geom_line() +
      geom_point() +
      geom_vline(xintercept = 2016, color='gray') +
      annotate("text", x=2015.3, y =50000, label="Trump\nelected", color='gray', hjust=0) +
      geom_vline(xintercept = 2012, color='gray') +
      annotate("text", x=2011.3, y =40000, label="Obama\nreelected", color='gray', hjust=0) +
      ggtitle('Ceilings Vs Actual Refugee Resettlements') +
      scale_y_continuous(labels = comma)

ggplotly(p, tooltip = c('y', 'label'))
```


We take a closer look at the top 5 countries that have refugees resettled in the USA (https://data.newamericaneconomy.org/en/refugee-resettlement-us/).

```{r}
total_demo <- ethnicity_df
total_demo$Total <- as.numeric(total_demo$Total)
change_in_pop <- total_demo %>%
  group_by(Year, country) %>%
  summarize(sum=sum(Total))

change_in_pop$events <- c('blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah', 'blah')
countries_plot <- ggplot(change_in_pop, aes(Year, sum, color=country, label=events))+
  geom_line() + 
  xlab("Year") + 
  ylab("Number of Individuals") +
  labs(title = "Change in Refugee Resettlement to the US 
       of Top 5 Refugee Origins from 2009-2018 ",
       caption = "Figure: Times series graph of top 5 refugee origins with the most number refugee resettlements.") +
  theme(legend.title = element_blank())

ggplotly(countries_plot, tooltip = c('y', 'label'))
```

The top 5 religions in the world are: Christianity, Islam, Hinduism, Buddhism, Sikhism (https://thecountriesof.com/top-5-largest-religions-in-the-world/). In Iraq, they separate the Muslim population into three categories: Muslim, Muslim Shiite, and Muslim Suni. For the purposes of this analysis, we will combine them as one.

```{r, fig.height=7}
muslim_names = c('Moslem', 'Moslem Suni', 'Moslem Shiite')

religion_df3 <- religion_df %>% 
  group_by(Year, Religion) %>%
  summarise(Inds = sum(Male) + sum(Female)) %>%
  mutate(Proportion = Inds / sum(Inds))

# rename to Moslem
religion_df3[religion_df3$Religion %in% muslim_names, 'Religion'] <- 'Moslem'

innerFunc <- function(sub_df){
  row <- head(sub_df, 1)
  row$Inds <- sum(head(sub_df$Inds))
  return(row)
}

religions = c('Christian', 'Moslem', 'Buddhist', 'Hindu')
subset_religion_df3 <- religion_df3[religion_df3$Religion %in% religions, ]

# combines Moslem for each year
create_religion_df <- function(current_df) {
  df <- do.call(rbind,
                  by(data=current_df[current_df$Year==2009, ],
                     INDICES=current_df[current_df$Year==2009, ]$Religion, FUN=innerFunc))
    
  for (year in c(2010:2018)) {
    df2 <- do.call(rbind,
                   by(data=current_df[current_df$Year==year, ],
                     INDICES=current_df[current_df$Year==year, ]$Religion, FUN=innerFunc))
    df <- rbind(df, df2)
}
  
  return(df)
}

subset_religion_df4 <- create_religion_df(subset_religion_df3)

subset_religion_df4$Religion <- factor(subset_religion_df4$Religion, levels = c('Christian','Moslem','Hindu', 'Buddhist'))

p2 <- ggplot(subset_religion_df4, aes(x= reorder(Religion, -Proportion), y=Proportion, fill=Religion)) + 
  geom_bar(stat="identity") +
  facet_grid(subset_religion_df4$Year) +
  labs(x = 'Religion', y = 'Proportion') +
  scale_x_discrete(labels = c('Christian','Muslim','Hindu', 'Buddhist')) +
  ggtitle('Religion Over Time') +
  theme(legend.position = 'none')
p2
```

```{r}
# todo: add plot for Education
edu_df<- select(filter(education_df, Education != "Bio Data not Complete" & Education != "Unknown"),c(Education,Total, country, Year))
edu_country <- edu_df %>% 
  group_by(country) %>%
  mutate(proportion = Total/sum(Total))
ggplot(edu_country, aes(x= reorder(Education, - proportion),y=proportion, fill=Education))+
  geom_bar(stat="identity")+
  facet_grid(edu_country$country) +
  theme(legend.position="none", plot.title=element_text(hjust=0.5))+
  ggtitle("Education Data by Country")
```


```{r, fig.width=8}
df_map <- arrival_df

# remove extra 6 'States'
df_map <- df_map[!df_map$State %in% c('American Samoa', 'District of Columbia', 'Guam', 'Puerto Rico', 'Unknown State', 'Virgin Islands'), ]
df_map$State <- as.factor(df_map$State)
df_map$code <- state.abb[match(df_map$State, state.name)]

#add Wyoming and Montana because they are misisng 
df_add <- data.frame(State = c('Wyoming','Wyoming','Montana'), Cases = c(0, 0, 0), Inds = c(0, 0, 0), Year = c(2009, 2010, 2010), code = c('WY', 'WY', 'MT'))

df_map <- rbind(df_map, df_add)

df_map$State <- tolower(df_map$State)

states <- map_data('state')

# fill = Inds? or cases?
map_basic <- ggplot(df_map, aes(map_id = State)) + 
  geom_map(aes(fill = Inds), map = states) + 
  expand_limits(x = states$long, y = states$lat) +
  facet_wrap(~Year) +
  scale_fill_gradient(low="#D6EAF8", high="#154360") +
  ggtitle('Refugee Resettlement in the US by State')

map_basic
```


# Interactive Component
```{r}
# remove extra 6 'States'
arrival_df2 <- arrival_df[!arrival_df$State %in% c('American Samoa', 'District of Columbia', 'Guam', 'Puerto Rico', 'Unknown State', 'Virgin Islands'), ]
arrival_df2$State <- as.factor(arrival_df2$State)
arrival_df2$code <- state.abb[match(arrival_df2$State, state.name)]

gg <- ggplot(arrival_df2, aes(code, Inds, frame = Year)) + 
  geom_bar(stat="identity", position='identity') +
  labs(x = "State", y="Individuals") +
  ggtitle('Refugee Resettlements By State from 2009-2018') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggplotly(gg)
```


# Conclusion

**WRITE STUFF**

